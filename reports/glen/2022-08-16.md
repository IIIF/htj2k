# Test run 18th August 2022

I will be using this document to detail the tests and scripts I ran to check htj2k decoding speeds against jp2 and ptiff. 


## Step 1: Source images

I am going to be using the same images and image URLs that Ruven has supplied and they can be found in:

[iiif_urls.txt](../../data/50_images/iiif_urls.txt)

To get the image names I ran:

```
cat data/50_images/iiif_urls.txt |awk -F\/ '{ print $1}' |sort |uniq  > data/image_list_50.txt
```

which created the [image_list_50.txt](../../data/50_images/image_list_50.txt) file which is a unique list of 50 filenames from the Getty collection of images. To download them I used the [imagelist.py](../../download/README.md) script as follows:

```
python imagelist.py ../data/50_images/image_list.txt ../imgs/50/original/
```

## Step 2: Generate the jp2, htj2k and ptiff derivatives 

I am going to use the convert.sh script but not I found an issue that the Mac date doesn't create Nano seconds so can't be used to do the timings. I've added a check to the convert script which will make sure you are using the GNU date. If not it won't make the log files.


PTiffs:

```
./convert/convert.sh imgs/50/original/ imgs/50/ptiff/lossy/ ptiff_lossy reports/glen/convert_logs 1
./convert/convert.sh imgs/50/original/ imgs/50/ptiff/lossless ptiff_lossless reports/glen/convert_logs 1
```

Compiling kakadu:

```
unzip v8_2_1-02075E.zip 
cd v8_2_1-02075E
```

Followed these instructions: https://github.com/IIIF/htj2k/tree/main/image_server 

```
cd make
make -f Makefile-Mac-x86-64-gcc clean
make -f Makefile-Mac-x86-64-gcc all_but_jni
```

and I've created a script which will add kdu to the path and also link in the libraries:

[setupKakadu.sh](setupKakadu.sh)

this can be run as follows:

```
source ./setupKakadu.sh
```

Although this didn't fix it as DYLD_LIBRARY_PATH is stripped by OS X... So I copied all of the libraries to /usr/local/lib:

```
cp ~/development/htj2k/image_server/kakadu/v8_2_1-02075E/lib/Mac-x86-64-gcc/* /usr/local/lib
```

Now I can generate the jp2s:

```
./convert.sh ../imgs/50/original/ ../imgs/50/jp2/lossy/ j2k1_lossy  reports/glen/convert_logs 1
./convert.sh ../imgs/50/original/ ../imgs/50/jp2/lossless/ j2k1_lossless reports/glen/convert_logs 1
./convert.sh ../imgs/50/original ../imgs/50/htj2k/lossless htj2k_lossless reports/glen/convert_logs 1
./convert.sh ../imgs/50/original ../imgs/50/htj2k/lossless htj2k_lossless reports/glen/convert_logs 1
```


## Step 3: Running docker

Ran the following to create the Docker:

```
docker build -t iipsrv_htj2k:latest . && docker run -e "IIPSRV_ENGINE=kakadu" -p 8000:8000 -v ~/development/htj2k/imgs/50:/data/images iipsrv_htj2k:latest
```

had to make a few changes. I had to change the commit as the fix Ruven did seems to have broken a full region request:

https://github.com/ruven/iipsrv/issues/232

also my Kakadu directory layout was slightly different so it would be good to pass this as a parameter.

First run as follows:

```
Type     Name                                                                          # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      htj2k-lossless                                                                  5563   111(2.00%) |     27       2    1075     18 |    5.56        0.11
GET      htj2k-lossy                                                                     5563   111(2.00%) |     27       3     434     19 |    5.56        0.11
GET      jp2-lossless                                                                    5563   111(2.00%) |     50       3     268     42 |    5.56        0.11
GET      jp2-lossy                                                                       5564   111(1.99%) |     54       2    1094     50 |    5.56        0.11
GET      ptiff-lossless                                                                  5564     0(0.00%) |     10       3     215     10 |    5.56        0.00
GET      ptiff-lossy                                                                     5564     0(0.00%) |     10       4     118     10 |    5.56        0.00
--------|----------------------------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                                     33381   444(1.33%) |     29       2    1094     16 |   33.37        0.44
```

Issues:
 * Failures on jp2s. Numbers all the same but error doesn't give the URL
 * Test doesn't end... it should end when all of the URLs have been tested. 

Maybe setup to start and stop the docker container between image tests...

Other tests I'd like to run:
 * info.json requests
 * full/full on all images
 * Stefano image requests.

